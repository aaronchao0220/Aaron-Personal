asyncapi: '3.0.0'
x-qlik-stability: stable
x-qlik-visibility: private
info:
  title: usage-tracker
  version: 1.4.0
  description: >-
    Supports control over consumption on multiple resources in QCS.
channels:
  consumptionChannel:
    address: 'system-events.consumption'
    messages:
      consumptionUnreported:
        $ref: '#/components/messages/consumptionUnreported'
      consumptionStatusUpdated:
        $ref: '#/components/messages/consumptionStatusUpdated'
      consumptionCollected:
        $ref: '#/components/messages/consumptionCollected'
      consumptionResourceConsumed:
        $ref: '#/components/messages/consumptionResourceConsumed'
      tenantResourcePurged:
        $ref: '#/components/messages/tenantResourcePurged'
operations:
  publishConsumptionEvents:
    action: send
    channel:
      $ref: '#/channels/consumptionChannel'
    messages:
      - $ref: '#/channels/consumptionChannel/messages/consumptionUnreported'
      - $ref: '#/channels/consumptionChannel/messages/consumptionStatusUpdated'
      - $ref: '#/channels/consumptionChannel/messages/consumptionCollected'
      - $ref: '#/channels/consumptionChannel/messages/consumptionResourceConsumed'
  publishPurgedEvent:
    action: send
    channel:
      $ref: '#/channels/consumptionChannel'
    messages:
      - $ref: '#/channels/consumptionChannel/messages/tenantResourcePurged' 

components:
  schemas:
    cloudEventsContextAttributes:
      required:
        - id
        - source
        - specversion
        - type
      description: CloudEvents Specification JSON Schema
      type: object
      properties:
        id:
          description: Identifies the event.
          type: string
          minLength: 1
          examples:
              - 'A234-1234-1234'
        source:
          description: Identifies the context in which an event happened.
          type: string
          format: uri-reference
          minLength: 1
          examples:
              - 'com.qlik/my-service'
        specversion:
          description: The version of the CloudEvents specification which the event uses.
          type: string
          minLength: 1
          examples:
              - '1.0'
        type:
          description: Describes the type of event related to the originating occurrence.
          type: string
          minLength: 1
          examples:
              - 'com.qlik.v1.app.created'
        datacontenttype:
          description: Content type of the data value. Must adhere to RFC 2046 format.
          type: string
          minLength: 1
        time:
          description: Timestamp of when the occurrence happened. Must adhere to RFC 3339.
          type: string
          format: date-time
          minLength: 1
    cloudEventsQlikExtensionsAttributes:
      type: object
      required:
        - userid
        - tenantid
      properties:
        userid:
          type: string
          example: VZhiEfgW2bLd7HgR-jjzAh6VnicipweT
          description: Unique identifier for the user triggering the event.
        tenantid:
          type: string
          example: VZhiEfgW2bLd7HgR-jjzAh6VnicipweT
          description: Unique identifier for the tenant related to the event.
        authtype:
          type: string
          description: Representing the type of principal that triggered the occurrence.
        authclaims:
          type: string
          description: A JSON string representing claims of the principal that triggered the event.
        traceparent:
          type: string
          description: Contains a version, trace ID, span ID, and trace options.
        tracestate:
          type: string
          description: A comma-delimited list of key-value pairs.
        host:
          type: string
          description: The hostname of the event producer for example pod name.
        toplevelresourceid:
          type: string
          description: The top level resource id.
    updateObject:
      type: object
      properties:
        updates:
          type: array
          description: Collection of updates performed on the resource.
          items:
            type: object
            properties:
              path:
                type: string
                description: Field that was updated.
              oldValue:
                type: string
                description: Value of the field before the update.
              newValue:
                type: string
                description: Value of the field after the update.
            example:
              {
                'path': '/attributePath',
                'oldValue': 'Dylan',
                'newValue': 'Dan',
              }
    limitsBasicEventPayload:
      type: object
      properties:
        scope:
          type: array
          description: Array of strings resource scope.
          example:
            - tenant
            - resourceId
            - resourceType
            - resourceAction
        resourceType:
          type: string
          description: the resource type
          enum:
            - app
            - automations
            - space
          example: 'app'
        resourceAction:
          type: string
          description: the resource action
          enum:
            - reload
            - reporting
          example: 'reload'
        guardRailLimit:
          type: number
          description: the resource guardrail limit
          example: 100
        capacityLimit:
          type: number
          description: the resource capacity limit
          example: 100
        localUsage:
          type: number
          description: the resource local usage
          example: 101
        globalUsage:
          type: number
          description: the resource global usage
          example: 20
    consumptionBasicEventPayload:
      type: object
      properties:
        scope:
          type: array
          description: Array of strings resource scope.
          example:
            - tenant
            - resourceId
            - resourceType
            - resourceAction
        resourceType:
          type: string
          description: the resource type
          enum:
            - app
            - automations
            - space
          example: 'app'
        resourceAction:
          type: string
          description: the resource action
          enum:
            - reload
            - reporting
          example: 'reload'
        capacityLimit:
          type: number
          description: the resource capacity limit
          example: 100
        localUsage:
          type: number
          description: the resource local usage
          example: 99
        overage:
          type: boolean
          description: the resource overage state
          example: false
        periodType:
          type: string
          description: the resource period type
          enum:
            - day
            - month
            - year
          example: month
        periodStart:
          type: string
          description: the resource period start
          example: '2021-10-01T00:00:00Z'
        periodEnd:
          type: string
          description: the resource period start
          example: '2021-10-31T123:59:59Z'
    tenantPurgedResult:
      type: object
      description: 'Result of the tenant purged operation, for the specific resourceType.'
      required:
        - purgedCount
        - purgeId
        - resourceType
        - success
      properties:
        errorMessage:
          type: string
          description: Detailed message about a failed purge operation.
          example: Failed to connect to database.
        purgedCount:
          type: number
          description: Number of resources that was successfully purged.
          example: 1000
        purgeId:
          type: string
          description: Unique identifier of the tenant purge request.
          example: 00000000-0000-0000-0000-000000000000
        resourceType:
          type: string
          description: Type of resource that was purged.
          example: audits
        success:
          type: boolean
          description: Status of the purge operation.
          example: true
  messages:
    consumptionUnreported:
      x-qlik-deprecated: true
      tags:
        - name: consumption
      title: Consumption unreported
      name: com.qlik.v1.consumption.unreported
      description: Notifies that there are executions that have not been picked up by licenses service.
      payload:
        type: object
        allOf:
          - $ref: '#/components/schemas/cloudEventsContextAttributes'
          - $ref: '#/components/schemas/cloudEventsQlikExtensionsAttributes'
          - type: object
            properties:
              type:
                type: string
                default: com.qlik.v1.consumption.unreported
                description: Unique identifier for the event type.
              data:
                type: object
                allOf:
                  - $ref: '#/components/schemas/consumptionBasicEventPayload'
                  - type: object
                    properties:
                      count:
                        type: number
                        default: 1
    consumptionCollected:
      tags:
        - name: consumption
      title: Consumption collected
      name: com.qlik.v1.consumption.collected
      description: Notifies about resource consumption in a certain period of time.
      payload:
        type: object
        allOf:
          - $ref: '#/components/schemas/cloudEventsContextAttributes'
          - $ref: '#/components/schemas/cloudEventsQlikExtensionsAttributes'
          - type: object
            properties:
              type:
                type: string
                default: com.qlik.v1.consumption.collected
                description: Unique identifier for the event type.
              data:
                type: object
                allOf:
                  - $ref: '#/components/schemas/consumptionBasicEventPayload'
    consumptionResourceConsumed:
      tags:
        - name: consumption
      title: Consumption resource consumed
      name: com.qlik.v1.consumption.resource.consumed
      description: Notifies when a resource consumption has been recorded.
      payload:
        type: object
        allOf:
          - $ref: '#/components/schemas/cloudEventsContextAttributes'
          - $ref: '#/components/schemas/cloudEventsQlikExtensionsAttributes'
          - type: object
            properties:
              type:
                type: string
                default: com.qlik.v1.consumption.resource.consumed
                description: Unique identifier for the event type.
              data:
                type: object
                allOf:
                  - $ref: '#/components/schemas/consumptionBasicEventPayload'
                  - type: object
                    properties:
                      causalEventId:
                        type: string
                        description: the ID of the principal source of the event
                      globalUsage:
                        type: number
                        description: the resource global usage
                      scopeMapping:
                        type: string
                        description: The map to the resource scope.
    consumptionStatusUpdated:
      tags:
        - name: consumption
      title: Consumption status updated
      name: com.qlik.v1.consumption.status.updated
      description: Notifies when a resource blocked or overage status has changed (resource has been blocked or unblocked or
        a resource has incurred in consumption overage or the resource is not in overage state anymore).
      payload:
        type: object
        allOf:
          - $ref: '#/components/schemas/cloudEventsContextAttributes'
          - $ref: '#/components/schemas/cloudEventsQlikExtensionsAttributes'
          - type: object
            properties:
              type:
                type: string
                default: com.qlik.v1.consumption.status.updated
                description: Unique identifier for the event type.
              data:
                type: object
                allOf:
                  - $ref: '#/components/schemas/limitsBasicEventPayload'
                  - $ref: '#/components/schemas/updateObject'
                  - type: object
                    properties:
                      overage:
                        type: boolean
                        description: the resource overage state
                        example: true
                      overageEventTime:
                        type: string
                        description: the overage event time
                        example: '2022-04-28T14:32:30Z'
                      blocked:
                        type: boolean
                        description: the resource block state
                        example: true
                      blockedEventTime:
                        type: string
                        description: the blocked event time
                        example: '2022-04-28T14:32:30Z'
                      description:
                        x-qlik-pii: true
                        type: string
                        description: the resource description
                        example: 'reloads by tenant'
                      resourceId:
                        type: string
                        description: the resource id
                        example: 'af31-06a29aef-b1b2-5e28a616-4508'
                      tenantId:
                        type: string
                        description: the tenant id
                        example: 'werv-06a29aef-b1b2-5e28a616-4508'
                      userId:
                        type: string
                        description: the user id
                        example: 'gcvb-06a29aef-b1b2-5e28a616-4508'
                      periodType:
                        type: string
                        description: the resource period type
                        enum:
                          - day
                          - month
                          - year
                        example: month
                      periodStart:
                        type: string
                        description: the resource period start
                        example: '2021-10-01T00:00:00Z'
                      periodEnd:
                        type: string
                        description: the resource period start
                        example: '2021-10-31T123:59:59Z'
                      unit:
                        type: string
                        description: the resource unit measure
                        example: 'GB'
                      segments:
                        type: array
                        example: [{'QDI': 10,'APP': 10}]
                        x-omitempty: true
                        items:
                          type: object
                          additionalProperties:
                            type: object
    tenantResourcePurged:
      title: TenantResource purged
      name: com.qlik.v1.consumption.tenant.purged
      description: >-
        This event will be published when the records of a tenant have
        been purged.
      tags:
        - name: consumption
      payload:
        type: object
        allOf:
          - $ref: '#/components/schemas/cloudEventsContextAttributes'
          - $ref: '#/components/schemas/cloudEventsQlikExtensionsAttributes'
          - type: object
            required:
              - data
              - type
            properties:
              type:
                type: string
                default: com.qlik.v1.consumption.tenant.purged
                description: Unique identifier for the event type.
              data:
                type: object
                description: Purge specific data related to the event.
                allOf:
                  - $ref: '#/components/schemas/tenantPurgedResult'
