# System event guidelines

## Version

This is version **5.2.0** of the guidelines. It's a live document and you
are very welcome to leave feedback or raise questions as either issues or
pull requests on [GitHub](https://github.com/qlik-trial/internal-qlik-dev), or on [Slack](https://qlikdev.slack.com/archives/CU68E4YAG).

## Introduction

The Qlik system event guidelines seek to guarantee quality, uniformity,
consistency, and usefulness of system events provided both internally and publicly.

- Each system event generated by the service should be documented.
- The documentation should be done in [AsyncAPI 3.0.0](https://www.asyncapi.com/docs/reference/specification/v3.0.0)
- The documentation should include the payload data, with the JSON structure described
  using [JSON-Schema](https://json-schema.org).

These guidelines are in many ways a contract, and it's assumed that any
given event in the platform adheres to it. The material is crowd-sourced and
you are very welcome to challenge, contribute, and help evolve these
guidelines. For reference, here are some other API guidelines:

- [Zalando](https://opensource.zalando.com/restful-api-guidelines/#events)

If you are looking for help how to design a service, see the
[service lifecycle](https://internal.qlik.dev/backend/microservices/highlights/).

Throughout the specification, it's recommended to follow the
[Google developer documentation style guide](https://developers.google.com/style/).

### Terminology

This section describes common terminology (and alternative keywords), and which
one that's preferred when you are referring to it.

Except for the requirement keywords "MUST," "MUST NOT," "REQUIRED," "SHALL,"
"SHALL NOT," "SHOULD," "SHOULD NOT," "RECOMMENDED," "MAY,"
and "OPTIONAL" used in these guidelines are to be interpreted as described in
[RFC 2119](https://www.ietf.org/rfc/rfc2119.txt), there are also some other common
keywords that **SHOULD** be followed:

| Keywords                                        | Preferred             | Description                                                                                                                                                                                                                                                                    |
| ----------------------------------------------- | --------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| `API`, `Service`                                | `API`                 | These guidelines apply to APIs, which technically could have many services solving the feature.                                                                                                                                                                                |
| `Client`, `User agent`, `Requestor`             | `Client`              | Used to describe someone or something passing data into an API, in other words, making a request.                                                                                                                                                                              |
| `Property`, `Field`, `Key`                      | `Field`               | Used to describe a member of a data model or structure, usually in JSON formats or query strings.                                                                                                                                                                              |
| `Parameter`, `Property`, `Argument`, `Variable` | `Parameter`           | Parameters are options you can pass with the endpoint (such as specifying the response format or the amount returned) to influence the response. There are four types of parameters: header parameters, path parameters, query string parameters, and request body parameters. |
| `Resource`, `(Domain) entity`                   | `Resource`            | Describes unique resources that clients may interact with in the platform.                                                                                                                                                                                                     |
| `Server`, `Server-side`, `Backend`, `Platform`  | `Platform`, `Backend` | Used to describe the environment a client interacts with when consuming these APIs.                                                                                                                                                                                            |

## How to use the guidelines

### Updating these guidelines

Here are some guidelines to updating the guidelines, so there can be more
guidelines:

- See the [Google developer documentation style guide](https://developers.google.com/style/highlights)
  for things to think about when contributing to these guidelines.
- Be careful when changing headings since links from other places might break,
  VSCode with the "Markdown All In One" extension does a good job of updating
  the table of contents automatically.

### Application of the guidelines

These guidelines are applicable to any system event exposed publicly or internally
by Qlik. Internal services tend to eventually be exposed publicly and
consistency is valuable to both external and internal system event consumers.

There can be legitimate reasons for exemption from these guidelines. An example
being if the system event need to conform with external event standards or for special
performance reasons.

Events used for service internal consumption only and not useful to other
services isn't required to be documented.

Internal events aren't required to follow the system events guidelines except
for [**MUST:** Use standardized channel names](/guidelines/event/event-payload-format/must-use-standardized-channel-names)
which applies to all events in the platform.

Examples:

- Work queue events
- Events used between replicas of a service

## Resources

Qlik R&D is an
[API First](https://github.com/qlik-trial/tlt-strategic-initiatives/blob/master/initiatives/api-first.md#api-first)
organization. If you are responsible for the API design, you should create the design
before anything else is implemented on top of it. This approach improves the
quality of the API because more general use cases are considered, and
requirements on it isn't solely UI-driven.

import Category from 'components/guidelines/GuidelinesCategory.astro';
import GuidelinesLegend from 'components/guidelines/GuidelinesLegend.astro';

## Guidelines

### API Documentation

#### **MUST:** Include common fields for events

- For each event, the documentation **MUST** include:
  - `name`: name of the event that **MUST** match eventType for consistent documentation
  - `title`: human-friendly name of the event
  - `description`: description of the event
- The `title` and `description` must follow the [API documentation guidelines](/general/api-strategy/guidelines/api-documentation/).

#### **MUST:** Include general AsyncAPI documentation fields

- For the general event description, the documentation **MUST** include:
  - `info`, which in turn **MUST** include `title`, `version` and `description`.
    The `description` field is used by tooling, and by providing proper
    metadata the user confidence in the provided events can be increased.
    Example of good description: The audit events allows you to gain insight of
    what goes on in your tenant. Example of bad description: Events for the management
    service.

##### API Specification

```yaml
asyncapi: '2.0.0'
info:
  title: Apps Events
  version: '1.0.0'
  description: |
    The Apps Events will allow you to keep track of the application lifecycle in the system.
channels: ...
```

#### **MUST:** Provide a JSON-Schema for payloads

An API **MUST** provide documentation for payloads
that follows the [JSON-Schema specification](https://json-schema.org).
This means, among other things, that every schema and all of their fields
(nested and otherwise) must have a valid type defined.

- The payload documentation **MUST** include:
  - `type`, and the type **MUST** be `object`.
  - **MUST** contain a list of `required` properties.
  - a list of the `properties`, where each property (field):
    - **MUST** include `type`.
    - **MUST** include `description` and follow the [API Documentation Guidelines](https://internal.qlik.dev/general/api-strategy/guidelines/api-documentation/#general-guidelines).
    - **MUST** include `const`, `example` or `default`.

##### API Specification

```yaml
noteData:
  type: object
  description: Note data properties.
  required:
    - ownerId
    - name
  properties:
    ownerId:
      type: string
      example: id123
      description: ID of the user who created the note or snapshot.
    description:
      type: string
      example: Discuss Q2 sales forecast
      description: Short description of what is in the note or snapshot.
    resourceId:
      type: string
      example: id123
      description: ID of the note or snapshot.
    name:
      type: string
      example: My note
      description: Name of the note or snapshot.
    spaceId:
      type: string
      example: id123
      description: Space ID where the note or snapshot resides.
    noteType:
      type: string
      const: note
      description: Note type
```

#### **MUST:** Use Qlik AsyncAPI extension for Customer Data fields

Any field that has been identified as a field containing Customer Assets Data or Customer Content
Data **MUST** be annotated with `x-qlik-customer-data: true`.

##### API Specification

```yaml
noteData:
  type: object
  description: Note or snapshot data properties.
  properties:
    creatorId:
      type: string
      example: id123
      description: ID of the user creating the note or snapshot.
    ownerId:
      type: string
      example: id123
      description: ID of the user who created the note or snapshot.
    description:
      type: string
      example: Discuss Q2 sales forecast
      description: Short description of what is in the note or snapshot.
      x-qlik-customer-data: true
    resourceId:
      type: string
      example: id123
      description: ID of the note or snapshot.
    name:
      type: string
      example: My note
      description: Name of the note or snapshot.
      x-qlik-customer-data: true
    spaceId:
      type: string
      example: id123
      description: Space ID where the note or snapshot resides.
```

##### More information

For more details on what constitutes a Customer Data field see [Customer Data guidelines](/backend/guidelines/customer-data-guidelines/)

#### **MUST:** Use Qlik AsyncAPI extension for `Deprecation`

The specification **MUST** include `x-qlik-deprecated` if an endpoint is
deprecated. Allowed values are `true` and `false`.
The deprecation policy is described in more detail in [apiculturist](https://apiculturist.qlikdev.com/governance/policy).

Default value is `false`. The deprecation period is further described in the
[Stability extension](#must-use-qlik-asyncapi-extension-for-stability).

##### API Specification

```yaml
messages:
  eventCreated:
    x-qlik-deprecated: true
    name: com.qlik.event.created
    description: Event created
    payload: ...
```

#### **MUST:** Use Qlik AsyncAPI extension for Personally Identifiable Information fields

Any field that has been identified as a field containing Personally
Identifiable Information (PII) **MUST** be annotated with `x-qlik-pii: true`.
The purpose of `x-qlik-pii: true` is to be able to highlight PII fields in API
documentation and to aid in PII related tasks.

Any uncertainties regarding fields being PII or not should be brought up with
the Software Security Office (SSO).

##### API Specification

```yaml
User:
  type: object
  required:
    - id
    - name
  properties:
    id:
      type: string
      format: uid
      readOnly: true
    name:
      type: string
      x-qlik-pii: true
```

##### More information

For more details on what constitutes a PII field see [PII Guidelines](/backend/guidelines/pii-guidelines/)

#### **MUST:** Use Qlik AsyncAPI extension for `Visibility`

The specification **MUST** include `x-qlik-visibility` to specify the
intended audience for the events. Allowed values:

- `public` - Event is intended for public use
- `private` - Event is intended for Qlik internal use only.

##### API Specification

```yaml
messages:
  eventCreated:
    x-qlik-visibility: public
    name: com.qlik.event.created
    description: Event created
    payload: ...
```

#### **MUST:** Use Qlik AsyncAPI extension for `Stability`

The specification **MUST** include `x-qlik-stability` to specify what
to expect from the events in terms of changes,
it also denotes the deprecation period. Allowed values:

- `stable`
  - Highly reliable
  - Breaking changes are extremely unlikely
- `experimental`
  - Unreliable
  - Experimental features aren't subject to the versioning policy
  - These events can be changed at any time without violating API governance

##### API Specification

```yaml
messages:
  eventCreated:
    x-qlik-stability: stable
    name: com.qlik.event.created
    description: Event created
    payload: ...
```

### Event Payload Format

#### **MUST:** Include full resource in the data field

The `data` field **MUST** contain the full resource the action is performed on, unless explicitly stated otherwise in these guidelines. See [standardized actions](#must-use-standardized-action-names).
The field **MUST** be present if stipulated by a [standardized action](/guidelines/event/event-payload-format/must-use-standardized-action-names/).
It **MAY** also be added to other action types if deemed valuable.

If the event originated from a sub resource the `data` field **MUST** contain the
full shallow sub resource. In alignment with
[**MUST:** Use Qlik Context Attributes in a standardized way](/guidelines/event/event-payload-format/must-use-qlik-extensions-context-attributes-in-a-standardized-way/)
the `toplevelresourceid` **MUST** be defined in the root level of the event structure (as a context attribute).

The resource **SHOULD** only contain the shallow resource,
subresources **SHOULD NOT** be included.

The resource **MUST** match the corresponding REST resource with the same major
version.

##### Example event payload

```json
{
  "specversion":"1.0",
  "source":"com.qlik/spaces",
  "type":"com.qlik.v1.space.created",
  ...
  "toplevelresourceid":"string",
  "ownerid": "string",
  "tenantid": "string",
  "data":{
    "id": "string",
    "type": "shared",
    "name": "string",
    "description": "string",
    "createdAt": "2020-10-21T12:06:40.855Z",
    "createdBy": "string",
    "updatedAt": "2020-10-21T12:06:40.855Z",
  }
}
```

#### **MUST:** Use approved resource in the event type

An API **MUST** use approved resources in the event type.

All new APIs **MUST** use a namespaced resource name to evolve the platform in a consistent way.

If a new resource/namespace needs to be introduced it **MUST** be approved by QAC and PM and added [here](https://github.com/qlik-trial/qac/blob/main/decision_logs/api2.0/allowed-resources-namespaces/events2_async-allowed-resources-namespaces.json).
The list of currently approved resources can be found [here](https://github.com/qlik-trial/qac/blob/main/decision_logs/api2.0/allowed-resources-namespaces/events1_async-allowed-resources.json).

##### Do

```text
com.qlik.telemetry.usage-telemetry.data-load.finished
```

##### Don't

```text
com.qlik.v1.usage-telemetry.data-load.finished
```

#### **MUST:** Use CloudEvents fields in a standardized way

The JSON Event Format defines how each field in the event **MUST** be defined.

[See the JSON Event format documentation](https://github.com/cloudevents/spec/blob/v1.0.2/cloudevents/formats/json-format.md)

While CloudEvents provide common fields and recommendations, Qlik need to
standardize on a way of using these fields. All fields in this list
**MUST** be included.

| Field             | Value                                          | Constraints           | Description                                                                                                                                                       |
| ----------------- | ---------------------------------------------- | --------------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `specversion`     | `1.0`                                          | REQUIRED              | All system events **MUST** follow version `1.0`                                                                                                                   |
| `datacontenttype` | `application/json`                             | REQUIRED              | The datacontenttype **MUST** be `application/json`                                                                                                                |
| `data`            | Object                                         | REQUIRED (APPLICABLE) | See [**MUST:** Include full resource in the data field](/guidelines/event/event-payload-format/must-include-full-resource-in-the-data-field/) |
| `id`              | `<uuid>`                                       | REQUIRED              | Unique identifier for the event instance                                                                                                                          |
| `time`            | `2018-04-05T17:31:00Z`                         | REQUIRED              | [ISO 8601](http://www.iso.org/iso/home/standards/iso8601.htm) format with Zulu time. (For example 2020-06-06T00:01:02.123Z)                                       |
| `type`            | `com.qlik.<namespace>.<eventContext>.<action>` | REQUIRED              | [**MUST:** Use Qlik pattern for type](/guidelines/event/event-payload-format/must-use-qlik-pattern-for-type/)                                 |
| `source`          | `com.qlik/<service-name>`                      | REQUIRED              | **MUST** be defined as `com.qlik/<service-name>`                                                                                                                  |

Example event payload:

```json
{
   "specversion":"1.0",
   "source":"com.qlik/edge-auth",
   "datacontenttype":"application/json",
   "type":"com.qlik.v1.space.created",
   "id":"<event id>",
   "time":"2018-10-30T07:06:22Z",
   "data":{...}
}
```

#### **MUST:** Use CloudEvents specification format

Qlik uses CloudEvents to ensure all events are described in a common way. The
events **MUST** follow version `1.0` of the specification.

[See the CloudEvents specification documentation](https://github.com/cloudevents/spec/tree/v1.0.2)

#### **MUST:** Use Qlik Extensions Context Attributes in a standardized way

The following fields are allowed as Qlik Extension Context Attributes, on the root level:

| Field                 | Type                        | Constraints           | Description                                                                                                                                                                                                                                                                 |
| --------------------- | --------------------------- | --------------------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `host`                | String                      | OPTIONAL              | The hostname of the event producer for example podname                                                                                                                                                                                                                      |
| `originip`            | String                      | OPTIONAL              | The IP address from which the HTTP request originated.                                                                                                                                                                                                                      |
| `ownerid`             | String                      | REQUIRED (APPLICABLE) | Id of the owner of the resource affected by the eventContext                                                                                                                                                                                                                |
| `sessionid`           | String                      | REQUIRED (APPLICABLE) | Session Identifier of the Event for interactive user sessions. Added to the JWT by [edge-auth](https://github.com/qlik-trial/edge-auth). **MUST** be defined if present in the JWT.                                                                                         |
| `spaceid`             | String                      | REQUIRED (APPLICABLE) | Id of the space related to the action performed on the eventContext. **MUST** be defined if the eventContext is part of a space                                                                                                                                             |
| `tenantid`            | String                      | REQUIRED (APPLICABLE) | Tenant Identifier of the Event. All system events originating within the context of a tenant **MUST** contain a `tenantid`. A rare exception would be system-level events not occurring within the tenant context, for example the system event which creates a new tenant. |
| `toplevelresourceid`  | String                      | REQUIRED (APPLICABLE) | If the event originated from a sub resource the `toplevelresourceid` **MUST** contain the id of the top level resource associated with the sub resource. If the event originated from a top level resource it **MUST NOT** be defined.                                        |
| `userid`              | String                      | REQUIRED (APPLICABLE) | Internal User Identifier of the Event used to know who triggered the event (not the user subject). This should map to the `userid` fields of the JWT. The subject isn't used here to not rely too much on external user identifiers.                                        |
| `clientid`            | String                      | REQUIRED (APPLICABLE) | OAuth-Client Identifier of the Event for OAuth token requests. Added to the JWT by [edge-auth](https://github.com/qlik-trial/edge-auth).                                                                                                                                    |
| `reason`              | String                      | OPTIONAL              | Contains information about what caused the event to be fired.                                                                                                                                                                                                               |

In CloudEvent v1 all the extensions context attributes are at the top-level and SHOULD follow same naming convention and use the same type system as the standard attributes:

- names should be lowercase alphanumeric characters
- names should be descriptive and concise, under 20 characters.
- allowed types are: `Boolean`, `Integer`, `Number`, `String`, `URI`, `Timestamp`, `URI-Reference`, `Binary`

The CloudEvents attribute naming convention can be found here: https://github.com/cloudevents/spec/blob/v1.0.2/cloudevents/spec.md#attribute-naming-convention

All field names under `data` **MUST** use `camelCase` to keep it consistent with the REST-resources.
`data._updates` and `data._meta` are exceptions to this rule, they are prefixed it with underscore `_` in order to avoid potential conflicts.

Example event payload:

```json
{
  "specversion":"1.0",
  "source":"com.qlik/spaces",
  "type":"com.qlik.v1.space.created",
  ...
  "tenantid":"<tenant id>",
  "userid":"<user id>",
  "sessionid":"<session id>",

  "data":{...}
}
```

#### **MUST:** Use Qlik pattern for type

To have predictable and uniform `type` the field **MUST** be
defined as `com.qlik.<namespace>.<eventContext>.<action>`.
The `type` **MUST** be unique in the system.

- `namespace`: **MUST** follow
  the REST resource namespace.
  For example if the resource the event relates to is in the `analytics` namespace then
  the event **MUST** also have the namespace `analytics`.
  This ensures consistency in the platform.
- `eventContext`: **MUST** be the API resource name, and subresource if the
  event applies to one. The resource name **MUST NOT** be plural in the `type`.
  The `eventContext` **MUST** use `kebab-case` just like the REST resource it represents.
- `action`: **MUST** be the action performed on the `eventContext` and follow
  [**MUST:** Use standardized action names](/guidelines/event/event-payload-format/must-use-standardized-action-names)

<Aside type="note" title="Note">
  All new APIs **MUST** use a namespaced resource name to evolve the platform in a consistent way.
  New namespace/resource, needs to be approved, see [must use approved resource in type](/guidelines/event/event-payload-format/must-use-approved-resource-in-type)
</Aside>

##### Legacy events

For legacy events in the platform the following naming convention was used:

To have predictable and uniform `type` the field **MUST** be
defined as `com.qlik.v<version>.<eventContext>.<action>`.
The `type` **MUST** be unique in the system.

- `version`: **MUST** be the major part of eventTypeVersion and **MUST** follow
  the REST resource versioning.
  For example if the resource the event relates to is major version `v1` then the
  event **MUST** also have major version `v1`. This ensures that the platform
  has consistent versioning of resources across API types.
- `eventContext`: **MUST** be the API resource name, and subresource if the
  event applies to one. The resource name **MUST NOT** be plural in the `type`.
  The `eventContext` **MUST** use `kebab-case` just like the REST resource it represents.
- `action`: **MUST** be the action performed on the `eventContext` and follow
  [**MUST:** Use standardized action names](/guidelines/event/event-payload-format/must-use-standardized-action-names)


#### **MUST:** Use standardized action names

All actions **MUST** be named as a past-tense verb as they have already happened.
Examples: `created`, `deleted`, `started`

Too keep the eventing uniform within the platform the following standards
**MUST** be followed:

| Type of event                | Action       | Description                                      | Examples that **MUST NOT** to be used     |
| ---------------------------- | ------------ | ------------------------------------------------ | ----------------------------------------- |
| Resource created             | `created`    | When a new resource has been created             | `generated`, `added`                      |
| Resource updated             | `updated`    | When a resource has been modified                | `modified`, `patched`, `changed`          |
| Resource deleted             | `deleted`    | When a resource has been removed                 | `destroyed`, `terminated`, `removed`      |
| Duration started             | `started`    | When a duration has started                      | `created`, `added`, `opened`              |
| Duration ended               | `ended`      | When a duration has ended                        | `stopped`, `removed`, `deleted`, `closed` |
| Asynchronous task triggered  | `triggered`  | When an asynchronous task has been started       | `added`, `created`, `initiated`           |
| Asynchronous task progressed | `progressed` | When an asynchronous task has been updated       | `updated`, `proceeded`, `continued`       |
| Asynchronous task finished   | `finished`   | When an asynchronous task has been completed     | `done`, `completed`                       |
| Tenant resource purged       | `purged`     | When cleaning up resources due to a tenant purge | `destroyed`, `terminated`, `removed`      |

Custom events that don't fall under the predefined actions **MUST NOT** use any
of the action names defined in the preceding table.

##### Examples

- `com.qlik.v1.app.created`
- `com.qlik.v1.app.updated`
- `com.qlik.v1.app.deleted`
- `com.qlik.v1.user.session.started`
- `com.qlik.v1.user.session.ended`
- `com.qlik.v1.alerting-task.triggered`
- `com.qlik.v1.alerting-task.progressed`
- `com.qlik.v1.alerting-task.finished`
- `com.qlik.v1.tenant.purged`

#### **MUST:** Use standardized channel names

The channel name **MUST** be consistently named to avoid confusion and conflicts.
The channel name **MUST** use the form `system-events.<top level resource>` for external
events, and `internal-events.<service-name>` for internal events.

If the events need to be separated further the `subresource` can be
suffixed to the channel name forming `system-events.<top level resource>.<subresource>`.

The resource **MUST** be singular to keep it consistent with `type`.

Channel names **MUST** be kebab-cased.

##### Examples

- `system-events.space`
- `system-events.user`
- `system-events.csp-origin`
- `system-events.app.session`
- `internal-events.quotas`
- `internal-events.edge-auth`

#### **MUST:** Use standardized purged action format

The `com.qlik.v<version>.<eventContext>.purged` events **MUST** follow the standardized purge format.


| Field               | Type   | Constraints           | Description                                                                                          |
| ------------------- | ------ | --------------------- | ---------------------------------------------------------------------------------------------------- |
| `data.errorMessage` | String | REQUIRED (APPLICABLE) | Error message for unsuccessful purges. **MUST** be set when the purge did not complete successfully. |
| `data.purgedCount`  | number | REQUIRED              | The reported number of records purged.                                                               |
| `data.purgeId`      | string | REQUIRED              | The unique id of the current tenant purge attempt.                                                   |
| `data.success`      | bool   | REQUIRED              | Denotes the outcome of the purge that was undertaken.                                                |
| `data.resourceType` | string | REQUIRED              | Descriptor of the resource purged.                                                                   |
| `tenantid`          | string | REQUIRED              | The id of the tenant for which the resource is purged.                                               |

```json
{
  ...
  "tenantid": "<tenant id>",
  "data": {
    "errorMessage": "Unsuccessful purge..",
    "purgedCount": 0,
    "purgeId": "1b83bb2c-d55b-4f0d-824f-760752348812",
    "resourceType": "audits",
    "success": false,
  }
  ...
}

```

#### **MUST:** Use standardized updates field

The `data._updates` field **MUST** be defined as an array of
update objects. Each update **MUST** be defined as follows:

```json
{
  ...
  "data": {
    ...
    "_updates": [
      {
        "path": "/ownerId",
        "oldValue": "value",
        "newValue": "updatedValue"
      }
    ]
  }
}
```

- `path`: **MUST** be specified as a [JSON pointer](https://tools.ietf.org/html/rfc6901)
  to the field that has been updated. The pointer **MUST** have the resource as
  the root.
- `oldValue`: The value the field had before the update was applied.
- `newValue`: The new value of the field.

> Note: the `_updates` field is prefixed with underscore in order to avoid potential conflicts with the message payload.

#### **SHOULD NOT:** Exceed the Size Limits (64Kb)

For performance reasons, CloudEvents v1 specification imposes limits on the size of the forwarded events as follows: [Size Limits spec](https://github.com/cloudevents/spec/blob/main/cloudevents/spec.md#size-limits)

- The total size of the message/event **MUST** be of a size of 64 KiB or less.

For bigger payloads the recommendation is to rather use the event payload to link to where the system can fetch the data. This can be achieved through the Dataref extension, here is an example on how it could look like:

```json
{
  "specversion" : "1.0",
  "type" : "com.qlik.v1.app.reload.finished",
  "source" : "com.qlik/engine",
  "id" : "58e633e4-9024-4701-a393-72c52a7a67e6",
  "datacontenttype" : "application/json",
  "data": {},
  "dataref" : "/v1/reloads/{reloadId}"
}
```

### Documented Context Attributes Extensions

#### **MUST** Use standardized Auth Context Extension fields

| Field        | Type   | Constraints           | Description                                                                  |
| ------------ | ------ | --------------------- | ---------------------------------------------------------------------------- |
| `authtype`   | String | REQUIRED (APPLICABLE) | An enum representing the type of principal that triggered the occurrence     |
| `authclaims` | String | REQUIRED (APPLICABLE) | A JSON string representing claims of the principal that triggered the event. |

The documented extension can be found [here](https://github.com/cloudevents/spec/blob/main/cloudevents/extensions/authcontext.md)

##### Example

```json
{
  "specversion":"1.0",
  "source":"com.qlik/spaces",
  "type":"com.qlik.v1.space.created",
  ...
  "authtype": "service_account",
  "authclaims": "{\"iss\":\"qlik.api.internal/data-engineering-exporter\",\"sub\":\"data-engineering-exporter\",\"subType\":\"service\"}"
}
```

#### **MUST** Use standardized Distributed Tracing Extension fields

| Field         | Type   | Constraints | Description                                                                           |
| ------------- | ------ | ----------- | ------------------------------------------------------------------------------------- |
| `traceparent` | String | OPTIONAL    | Contains a version, trace ID, span ID.                                                |
| `tracestate`  | String | OPTIONAL    | A comma-delimited list of key-value pairs, following the Single Header b3-propagation |
|               |        |             |                                                                                       |

The documented extension can be found [here](https://github.com/cloudevents/spec/blob/main/cloudevents/extensions/distributed-tracing.md)

##### Example

```json
{
  "specversion":"1.0",
  "source":"com.qlik/spaces",
  "type":"com.qlik.v1.space.created",
  ...
  "traceparent": "00-{traceId}-{spanId}-01",
  "tracestate": "b3={traceId}-{spanId}-{(optional)1}-{(optional){parentSpanId}}"
}
```

### Versioning and Deprecation

#### **MUST:** Indicate deprecation in a standardized way

When something in the API is being deprecated it **MUST** be indicated in the specification.
This information is then used to communicate to both internal and external developers that they
need to adapt.

The deprecation is marked with the following properties:
| Property                      | Type    | Description |
| ----------------------------- | ------- | ---------------------------------------------- |
| x-qlik-deprecated             | Boolean | Stating that the related entity is deprecated. |
| x-qlik-deprecated-version     | String  | YYYY-MM - specifies the next quarterly release from which the deprecation period will start counting. |
| x-qlik-deprecated-description | String  | Descriptive text in relation to the deprecation, this will be rendered on qlik.dev |
| x-qlik-deprecated-sunset      | String  | YYYY-MM- Can be used to document custom sunset periods, defaults to 12 months from x-qlik-deprecated-version|

##### Async API Documentation

Entire entity deprecated

```yaml
asyncapi: 3.0.0
x-qlik-stability: stable
x-qlik-visibility: private
info:
  title: usage-tracker
  version: 2.0.0
  description: Supports control over consumption on multiple resources in QCS.
channels:
  consumptionChannel:
    address: 'system-events.consumption'
    messages:
      consumptionUnreported:
        $ref: '#/components/messages/consumptionUnreported'
....
messages:
  consumptionUnreported:
    x-qlik-deprecated: true
    x-qlik-deprecated-version: 2025-02
    x-qlik-deprecated-sunset: 2026-02
    x-qlik-deprecated-description: The reason for this being removed
    title: Consumption unreported
    name: com.qlik.v1.consumption.unreported
    description: Notifies that there are executions that have not been picked up by licenses service.
    payload:
        ...
```

Parameter deprecated

```diff
...
messages:
  consumptionUnreported:
    ...
    payload:
      type: object
      allOf:
        ...
        - type: object
          properties:
            type:
              type: string
              default: com.qlik.v1.consumption.unreported
            data:
              type: object
              allOf:
                ...
                - type: object
                  properties:
                    count:
+                     x-qlik-deprecated: true
+                     x-qlik-deprecated-version: 2025-02
+                     x-qlik-deprecated-sunset: 2026-02
+                     x-qlik-deprecated-description: this field will be replaced by total
                      type: number
                      default: 1
+                   total:
+                     type: number
+                     default: 0
```

#### **MUST:** Use `semantic versioning` for API version

The versioning **MUST** follow [semantic versioning](https://www.semver.org) and
the full API version **MUST** be specified in the API specification.

##### API Specification

```yaml
asyncapi: 3.0.0
x-qlik-stability: stable
x-qlik-visibility: private
info:
  title: usage-tracker
  version: 2.1.0
  description: Supports control over consumption on multiple resources in QCS.
channels:
```
